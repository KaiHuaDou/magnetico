name: Build Windows

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: "1.25"

      - name: Setup MSYS2 and install dependencies
        uses: msys2/setup-msys2@v2
        with:
          update: true
          install: >
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-sqlite3
            mingw-w64-x86_64-zeromq
            mingw-w64-x86_64-libsodium
            mingw-w64-x86_64-czmq
            mingw-w64-x86_64-pkg-config

      - name: Add mingw-w64 to PATH
        shell: powershell
        run: |
          $mingw = "${env:MSYS2_PATH}\mingw64\bin"
          Write-Host "Adding $mingw to PATH"
          echo "$mingw" >> $env:GITHUB_PATH

      - name: Show environment / sanity
        shell: bash
        run: |
          which x86_64-w64-mingw32-gcc || echo "gcc not found"
          x86_64-w64-mingw32-gcc --version || true
          go version
          go env
          echo "MSYS2_PATH=$MSYS2_PATH"
          # quick checks for headers/libs
          ls -l "${MSYS2_PATH}/mingw64/include/zmq.h" || echo "zmq.h not found in mingw64 include"
          ls -l "${MSYS2_PATH}/mingw64/lib/libzmq*" || echo "libzmq not found in mingw64 lib"
          pkg-config --list-all | grep libzmq || echo "pkg-config does not list libzmq (ok if pkg-config not used)"

      - name: Build magnetico (Windows amd64)
        shell: bash
        env:
          CGO_ENABLED: "1"
          CC: x86_64-w64-mingw32-gcc
          GOOS: windows
          GOARCH: amd64
        run: |
          # ensure pkgconfig points to mingw64 .pc files and cgo can find headers/libs
          export PKG_CONFIG_PATH="${MSYS2_PATH}/mingw64/lib/pkgconfig:${MSYS2_PATH}/usr/lib/pkgconfig"
          export CGO_CFLAGS="-I${MSYS2_PATH}/mingw64/include"
          export CGO_LDFLAGS="-L${MSYS2_PATH}/mingw64/lib"
          echo "PKG_CONFIG_PATH=$PKG_CONFIG_PATH"
          pkg-config --modversion libzmq || echo "libzmq pc not found; continuing to try build using direct flags"
          go env
          # build with fts5 tag as before
          go build -tags "fts5" -ldflags="-s -w" -o magnetico-windows-amd64.exe .

      - name: Verify executable
        shell: bash
        run: |
          file magnetico-windows-amd64.exe || true
          ls -lh magnetico-windows-amd64.exe

      - name: Upload artifact (exe)
        uses: actions/upload-artifact@v4
        with:
          name: magnetico-windows-amd64
          path: magnetico-windows-amd64.exe
